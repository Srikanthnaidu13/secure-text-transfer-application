<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Text Submission</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="p-5">
  <div class="container fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="text-primary">🔒 Secure Text Portal</h2>
        {% if current_user %}
          <h6 class="text-muted">Welcome, {{ current_user }}</h6>
        {% endif %}
      </div>
      <div>
        {% if current_user %}
          <a href="/logout_user" class="btn btn-outline-secondary me-2">Logout</a>
        {% endif %}
        <a href="/login" class="btn btn-outline-primary">Admin Login</a>
      </div>
    </div>

    {% if not current_user %}
      <!-- Only show before login -->
      <form method="POST" action="/set_user" class="card p-4 mb-4">
        <input type="text" name="username" class="form-control mb-2" placeholder="Enter your name" required>
        <button class="btn btn-primary">Start Session</button>
      </form>
    {% else %}
      <!-- After login -->
      {% if submitted %}
        <div class="alert alert-success">✅ Your message was successfully submitted!</div>
      {% endif %}
      <form action="/submit" method="POST" class="card p-4 mb-4">
        <textarea name="text" class="form-control mb-2" rows="4" placeholder="Enter your message" required></textarea>
        <button class="btn btn-primary w-100">Submit</button>
      </form>

      <!-- Messages shown after login -->
      <h4>🔐 Encrypted Messages</h4>
      <ul id="messageList" class="list-group"></ul>
    {% endif %}
  </div>

{% if current_user %}
<script>
fetch('/get_messages')
  .then(res => res.json())
  .then(data => {
    const list = document.getElementById('messageList');
    list.innerHTML = '';

    data.forEach(msg => {
      const item = document.createElement('li');
      item.className = 'list-group-item';

      let content = `
        <b>From:</b> ${msg.submitted_by}<br>
        <b>Time:</b> ${new Date(msg.timestamp).toLocaleString()}<br>
      `;

      const safeTimestamp = encodeURIComponent(msg.timestamp);

      if (msg.access_status === 'approved' && msg.is_verified) {
        content += `<b>Message:</b> ${msg.text}`;
      } else if (msg.access_status === 'approved') {
        content += `
          <b>Message:</b> 🔐 <span class="text-warning">Enter Passcode</span>
          <form onsubmit="verifyPasscode(event, '${safeTimestamp}', ${msg.id})">
            <input type="text" name="passcode" class="form-control form-control-sm mb-2" placeholder="Enter Passcode" required>
            <button class="btn btn-sm btn-success" type="submit">View</button>
          </form>
          <div class="text-danger mt-1" id="error-${msg.id}"></div>
        `;
      } else if (msg.access_status === 'pending') {
        content += `<b>Message:</b> ⏳ Request pending...`;
      } else if (msg.access_status === 'rejected') {
        content += `<b>Message:</b> ❌ Access Denied`;
      } else {
        content += `
          <form action="/request_access" method="POST" class="mt-2">
            <input type="hidden" name="message_id" value="${msg.id}">
            <button class="btn btn-sm btn-warning">Request Access</button>
          </form>
        `;
      }

      item.innerHTML = content;
      list.appendChild(item);
    });
  });

function verifyPasscode(event, timestamp, msgId) {
  event.preventDefault();
  const form = event.target;
  const passcode = form.querySelector('input[name="passcode"]').value;

  fetch('/verify_passcode_ajax', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ passcode: passcode, message_id: msgId })
  })
  .then(res => res.json())
  .then(data => {
    const msgBlock = form.closest('.list-group-item');
    const errorBox = msgBlock.querySelector(`#error-${msgId}`);
    
    if (data.success) {
      msgBlock.innerHTML = `
        <b>From:</b> ${data.submitted_by}<br>
        <b>Time:</b> ${new Date(data.timestamp).toLocaleString()}<br>
        <b>Message:</b> ${data.message}
      `;
    } else {
      errorBox.textContent = data.error || "Invalid passcode";
    }
  });
}

</script>
{% endif %}
</body>
</html>
