<!-- templates/admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    .fade-in { animation: fadeIn 0.6s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="fade-in">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-success">🛡️ Admin Panel</h2>
      <a href="/logout_admin" class="btn btn-outline-danger">Logout</a>
    </div>

    <h4 class="mb-3">📬 All Decrypted Messages</h4>
    <ul id="adminMessages" class="list-group mb-5"></ul>

    <h4 class="mb-3">🔐 Access Requests</h4>
    <ul id="requests" class="list-group"></ul>
  </div>

  <script>
    // Load decrypted messages
    fetch('/admin/get_messages')
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById('adminMessages');
        list.innerHTML = '';
        data.forEach(msg => {
          const item = document.createElement('li');
          item.className = 'list-group-item d-flex justify-content-between align-items-start';
          item.dataset.messageId = msg.id;
          item.innerHTML = `
            <div>
              <b>User:</b> ${msg.submitted_by}<br>
              <b>Time:</b> ${new Date(msg.timestamp).toLocaleString()}<br>
              <b>Message:</b> ${msg.text}
            </div>
            <button class="btn btn-sm btn-outline-danger ms-3 delete-btn" data-id="${msg.id}">🗑️</button>
          `;
          list.appendChild(item);
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const messageId = btn.dataset.id;
            fetch('/admin/delete_message', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: `message_id=${messageId}`
            }).then(res => {
              if (res.ok) {
                const li = document.querySelector(`[data-message-id="${messageId}"]`);
                if (li) li.remove();
              }
            });
          });
        });
      });

function loadRequests() {
  fetch('/admin/requests')
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('requests');
      list.innerHTML = '';
      data.forEach(req => {
        const item = document.createElement('div');
        item.className = 'card p-3 mb-3';
        item.dataset.requestId = req.id;
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <b>${req.user_id}</b> requested access to message <b>#${req.message_id}</b><br>
              Status: <span class="text-muted">${req.status}</span>
            </div>
            <div>
              <button class="btn btn-sm btn-success grant-btn me-2">Grant</button>
              <button class="btn btn-sm btn-danger reject-btn">Reject</button>
            </div>
          </div>
        `;
        list.appendChild(item);
      });
      attachListeners();
    })
    .catch(console.error);
}

function attachListeners() {
  document.querySelectorAll('.grant-btn').forEach(btn => {
    btn.onclick = () => {
      const id = btn.closest('.card').dataset.requestId;
      handleAction(id, 'approved');
    };
  });
  document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.onclick = () => {
      const id = btn.closest('.card').dataset.requestId;
      handleAction(id, 'rejected');
    };
  });
}

function handleAction(requestId, action) {
  fetch('/admin/grant_access', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `request_id=${requestId}&action=${action}`
  })
  .then(res => res.json())
  .then(data => {
    const card = document.querySelector(`[data-request-id="${requestId}"]`);
    if (!card) return;

    if (data.action === 'approved') {
      card.innerHTML = `
        <div class="text-success">
          ✅ Access granted for <strong>${data.user_id}</strong> on message <strong>#${data.message_id}</strong><br>
          🔑 <strong>Passcode:</strong> <code>${data.passcode}</code><br>
          Share this with the user.
        </div>
      `;
    } else {
      card.remove();
    }
  })
  .catch(console.error);
}

window.onload = loadRequests;

function handleAction(requestId, action) {
  fetch('/admin/grant_access', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `request_id=${requestId}&action=${action}`
  })
  .then(res => res.json())
  .then(data => {
    const card = document.querySelector(`[data-request-id="${requestId}"]`);
    if (!card) return;

    if (data.action === 'approved') {
      card.innerHTML = `
        <div class="text-success">
          ✅ Access granted to <b>${data.user_id}</b> for message <b>#${data.message_id}</b><br>
          <b>Passcode:</b> <code>${data.passcode}</code>
        </div>
      `;
    } else {
      card.remove();
    }
  });
}


</script>

</body>
</html>  
